<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audio Step Sequencer</title>
  <style>
    :root{
      --bg:#0a0f1f;            /* deep space */
      --panel:#0f1630;         /* panel base */
      --accent:#5ef0ff;        /* neon cyan */
      --accent2:#a45bff;       /* neon purple */
      --accent3:#00ffa6;       /* neon mint */
      --text:#cfe8ff;          /* light text */
      --muted:#6a7ca6;
      --danger:#ff4d6d;
      --step-off:#141b34;
      --step-on:#101d3d;
      --shadow: 0 0 0.5rem #47e6ff80, 0 0 1.5rem #8e5bff40 inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:
        radial-gradient(1200px 800px at 85% -10%, #2a1b6a20 0%, transparent 60%),
        radial-gradient(1000px 700px at -10% 110%, #02ffd020 0%, transparent 60%),
        linear-gradient(180deg, #050813, var(--bg));
      overflow-x:hidden;
    }
    .container{max-width:1100px; margin:32px auto; padding:0 16px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;
    }
    .title{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:38px; aspect-ratio:1; border-radius:12px;
      background: conic-gradient(from 200deg at 50% 50%, var(--accent), var(--accent2), var(--accent3), var(--accent));
      filter:saturate(130%); box-shadow:0 0 18px #5ef0ff55;
      position:relative;
    }
    .logo::after{content:""; position:absolute; inset:4px; border-radius:10px; background:#0b0f20aa; backdrop-filter: blur(2px);}
    h1{margin:0; font-weight:800; letter-spacing:0.5px; text-transform:uppercase; font-size:clamp(18px, 2.4vw, 28px);}
    .badge{font-size:12px; letter-spacing:1.5px; color:var(--accent3); border:1px solid #00ffa655; padding:4px 8px; border-radius:999px; box-shadow: inset 0 0 8px #00ffa620, 0 0 12px #00ffa620;}

    .panel{background:linear-gradient(180deg, #0f1630, #0a122b); border:1px solid #2b3d74; border-radius:16px; box-shadow: var(--shadow);}

    .controls{display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; padding:16px;}
    .control{background:linear-gradient(180deg, #0d1738, #0c1330); border:1px solid #243464; border-radius:12px; padding:12px; box-shadow: inset 0 0 12px #16265a80;}
    .control h3{margin:0 0 10px; font-size:12px; letter-spacing:1px; color:var(--muted); text-transform:uppercase}
    .row{display:flex; align-items:center; gap:10px}
    .row input[type="range"]{width:100%}
    .value{font-variant-numeric: tabular-nums; min-width:42px; text-align:right; color:var(--accent)}

    .transport{display:flex; align-items:center; gap:12px}
    button{
      appearance:none; border:1px solid #2b3d74; background:linear-gradient(180deg, #0e1b44, #0c183a); color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:0.3px;
      box-shadow: 0 0 10px #5ef0ff20; transition: transform .08s ease, box-shadow .2s ease, border-color .2s;
    }
    button:hover{ box-shadow: 0 0 16px #5ef0ff40; border-color:#3a55a0; }
    button:active{ transform: translateY(1px) scale(0.99); }
    .primary{ border-color:#3ad9ff; background:linear-gradient(180deg, #0b2e4a, #0a2238); box-shadow: 0 0 16px #3ad9ff44, inset 0 0 10px #3ad9ff26; }
    .danger{ border-color:#ff4d6d77; box-shadow: 0 0 12px #ff4d6d33; }

    .grid{
      margin-top:16px; padding:16px; display:grid; gap:12px;
    }
    .track{display:grid; grid-template-columns:120px repeat(16, 1fr); gap:8px; align-items:center}
    .track .label{background:linear-gradient(180deg, #0f1c44, #0c1530); border:1px solid #2b3d74; border-radius:10px; padding:10px; text-align:center; font-weight:700; letter-spacing:0.5px}

    .cell{
      position:relative; height:34px; border-radius:10px; border:1px solid #23356a; background: var(--step-off);
      cursor:pointer; transition: transform .05s ease, box-shadow .2s ease, background .15s ease, border-color .2s ease, filter .2s ease;
      box-shadow: inset 0 -10px 18px #00000040;
    }
    .cell.on{ background: var(--step-on); border-color:#3ad9ff88; box-shadow: 0 0 16px #3ad9ff33, inset 0 0 18px #3ad9ff22; }
    .cell.on::after{
      content:""; position:absolute; inset:0; border-radius:10px; box-shadow: inset 0 0 10px currentColor, 0 0 22px currentColor;
      opacity:0.7; mix-blend-mode:screen; filter:saturate(150%);
    }
    .cell:nth-child(4n+0){outline: 1px dashed #35509a44; outline-offset: -4px}
    .cell.playhead{ transform: translateY(-1px); filter: drop-shadow(0 0 10px #5ef0ff88) saturate(150%); }

    footer{opacity:0.8; margin:18px 0 40px; font-size:12px; text-align:center;}
    a{color:var(--accent)}

    /* Pulse anim for PLAY state */
    .playing-indicator{
      width:10px; height:10px; border-radius:999px; background:var(--accent3); box-shadow: 0 0 12px #00ffa6aa; display:inline-block; margin-left:8px;
      animation: throb 1.2s ease-in-out infinite;
    }
    @keyframes throb{ 0%{transform:scale(1)} 50%{transform:scale(1.5)} 100%{transform:scale(1)} }

    /* Responsive tweaks */
    @media (max-width: 760px){
      .controls{grid-template-columns:1fr;}
      .track{grid-template-columns:90px repeat(16, 1fr)}
      .cell{height:28px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Audio Step Sequencer</h1>
          <div class="badge">WebAudio • 16‑Step • Futuristic</div>
        </div>
      </div>
      <div class="transport">
        <button id="playBtn" class="primary">Play</button>
        <button id="stopBtn">Stop</button>
        <span id="playingDot" class="playing-indicator" style="display:none"></span>
      </div>
    </header>

    <section class="panel controls">
      <div class="control">
        <h3>Tempo</h3>
        <div class="row">
          <input id="tempo" type="range" min="60" max="200" value="120">
          <div class="value"><span id="tempoVal">120</span> BPM</div>
        </div>
      </div>
      <div class="control">
        <h3>Swing</h3>
        <div class="row">
          <input id="swing" type="range" min="0" max="100" value="0">
          <div class="value"><span id="swingVal">0</span>%</div>
        </div>
      </div>
      <div class="control">
        <h3>Pattern</h3>
        <div class="row" style="flex-wrap:wrap; gap:8px">
          <input id="patternName" placeholder="Name this pattern" style="flex:1; padding:10px; border-radius:10px; border:1px solid #2b3d74; background:#0b1430; color:var(--text)"/>
          <button id="savePattern">Save</button>
          <select id="patternList" style="flex:1; min-width:160px; padding:10px; border-radius:10px; border:1px solid #2b3d74; background:#0b1430; color:var(--text)"></select>
          <button id="loadPattern">Load</button>
          <button id="deletePattern" class="danger">Delete</button>
        </div>
      </div>
    </section>

    <section class="panel grid" id="grid"></section>

    <section class="panel" style="margin-top:16px; padding:16px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between">
      <div class="row" style="gap:12px; align-items:center">
        <button id="clearBtn">Clear</button>
        <button id="randomBtn">Randomize</button>
      </div>
      <div class="row" style="gap:10px; align-items:center">
        <label for="loops">Export Loops:</label>
        <input id="loops" type="number" value="2" min="1" max="16" style="width:64px; padding:8px; border-radius:10px; border:1px solid #2b3d74; background:#0b1430; color:var(--text)">
        <button id="exportBtn" class="primary">Export WAV</button>
      </div>
    </section>

    <footer>
      <small>Made with ❤️ and the WebAudio API. Tip: use <em>Randomize</em> then tweak.
      </small>
    </footer>
  </div>

<script>
// =======================
// Audio Engine & Sequencer
// =======================
const NUM_STEPS = 16;
const STORAGE_KEY = 'audio-step-sequencer-patterns-v1';
let audioCtx = null;       // Created on user interaction
let isPlaying = false;
let currentStep = 0;
let nextNoteTime = 0;      // in audioCtx time
let timerID;
let scheduleAheadTime = 0.12; // seconds
let lookahead = 25;           // ms

const state = {
  tempo: 120,
  swing: 0, // 0..100
  tracks: [
    { name: 'Kick',  color: '#00ffa6', steps: Array(NUM_STEPS).fill(false) },
    { name: 'Snare', color: '#5ef0ff', steps: Array(NUM_STEPS).fill(false) },
    { name: 'Hat',   color: '#a45bff', steps: Array(NUM_STEPS).fill(false) },
    { name: 'Clap',  color: '#ff9bda', steps: Array(NUM_STEPS).fill(false) },
  ],
};

// Utility: compute 16th note duration
function stepDurationSec(tempo){ return 60 / tempo / 4; }

function ensureAudio(){
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

// Instruments (synth)
function playKick(time){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.setValueAtTime(150, time);
  o.frequency.exponentialRampToValueAtTime(50, time + 0.12);
  g.gain.setValueAtTime(1.0, time);
  g.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
  o.connect(g).connect(audioCtx.destination);
  o.start(time); o.stop(time + 0.16);
}

function playSnare(time){
  // Noise burst
  const bufferSize = audioCtx.sampleRate * 0.2;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<buffer.length;i++) data[i] = Math.random()*2-1;

  const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
  const bp = audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 1800; bp.Q.value=0.8;
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.2);

  // Body (sine blip)
  const o = audioCtx.createOscillator(); o.type='triangle';
  const g2 = audioCtx.createGain(); g2.gain.setValueAtTime(0.4, time); g2.gain.exponentialRampToValueAtTime(0.001, time+0.12);
  o.frequency.setValueAtTime(220, time); o.frequency.exponentialRampToValueAtTime(160, time+0.1);

  noise.connect(bp).connect(g);
  o.connect(g2);
  const mix = audioCtx.createGain(); mix.gain.value = 1.0;
  g.connect(mix); g2.connect(mix); mix.connect(audioCtx.destination);
  noise.start(time); noise.stop(time+0.2); o.start(time); o.stop(time+0.12);
}

function playHat(time){
  const len = 0.07;
  const bufferSize = audioCtx.sampleRate * len;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<buffer.length;i++) data[i] = (Math.random()*2-1) * (1 - i/buffer.length);
  const src = audioCtx.createBufferSource(); src.buffer = buffer; src.loop=false;
  const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; hp.Q.value=0.7;
  const g = audioCtx.createGain(); g.gain.setValueAtTime(0.35, time); g.gain.exponentialRampToValueAtTime(0.001, time+len);
  src.connect(hp).connect(g).connect(audioCtx.destination);
  src.start(time); src.stop(time+len);
}

function playClap(time){
  // Simple clap = short noise burst with multiple quick decays
  const bursts = [0, 0.012, 0.025, 0.045];
  bursts.forEach((off,i)=>{
    const bufLen = audioCtx.sampleRate * 0.12;
    const buffer = audioCtx.createBuffer(1, bufLen, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let j=0;j<buffer.length;j++) data[j] = Math.random()*2-1;
    const src = audioCtx.createBufferSource(); src.buffer=buffer;
    const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000; hp.Q.value=0.5;
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.5/(i+1), time+off);
    g.gain.exponentialRampToValueAtTime(0.001, time+off+0.12);
    src.connect(hp).connect(g).connect(audioCtx.destination);
    src.start(time+off); src.stop(time+off+0.12);
  });
}

function trigger(trackIndex, time){
  switch(trackIndex){
    case 0: playKick(time); break;
    case 1: playSnare(time); break;
    case 2: playHat(time); break;
    case 3: playClap(time); break;
  }
}

// Scheduling with swing
function scheduleStep(step, when){
  const baseDur = stepDurationSec(state.tempo);
  const swingAmt = (state.swing/100) * (baseDur * 0.5); // push off-16ths later
  const isSwung = (step % 2 === 1); // 0-based: odd steps swung
  const time = when + (isSwung ? swingAmt : 0);
  state.tracks.forEach((t,ti)=>{ if (t.steps[step]) trigger(ti, time); });
  // Visual playhead mark
  requestAnimationFrame(()=> highlightPlayhead(step));
}

function scheduler(){
  const baseDur = stepDurationSec(state.tempo);
  while(nextNoteTime < audioCtx.currentTime + scheduleAheadTime){
    scheduleStep(currentStep, nextNoteTime);
    nextNoteTime += baseDur; // base timeline
    currentStep = (currentStep + 1) % NUM_STEPS;
  }
}

function start(){
  ensureAudio();
  isPlaying = true; document.getElementById('playingDot').style.display='inline-block';
  currentStep = 0; nextNoteTime = audioCtx.currentTime + 0.05;
  timerID = setInterval(scheduler, lookahead);
}

function stop(){
  isPlaying = false; document.getElementById('playingDot').style.display='none';
  clearInterval(timerID);
  clearPlayhead();
}

// =======================
// UI Grid
// =======================
const gridEl = document.getElementById('grid');
function buildGrid(){
  gridEl.innerHTML = '';
  state.tracks.forEach((track, ti)=>{
    const row = document.createElement('div'); row.className = 'track';
    const label = document.createElement('div'); label.className='label'; label.textContent=track.name; label.style.color=track.color; row.appendChild(label);
    for(let s=0;s<NUM_STEPS;s++){
      const cell = document.createElement('div'); cell.className='cell';
      cell.dataset.ti = ti; cell.dataset.si = s;
      cell.style.setProperty('color', track.color);
      cell.addEventListener('click', ()=>{
        const t = state.tracks[ti];
        t.steps[s] = !t.steps[s];
        cell.classList.toggle('on', t.steps[s]);
      });
      row.appendChild(cell);
    }
    gridEl.appendChild(row);
  });
}

function refreshGrid(){
  document.querySelectorAll('.cell').forEach(cell=>{
    const ti = +cell.dataset.ti, si=+cell.dataset.si;
    cell.classList.toggle('on', !!state.tracks[ti].steps[si]);
  });
}

function highlightPlayhead(step){
  document.querySelectorAll('.cell').forEach(cell=> cell.classList.remove('playhead'));
  document.querySelectorAll(`.track`).forEach(trackRow=>{
    const cell = trackRow.children[1+step]; // first child is label
    if (cell) cell.classList.add('playhead');
  });
}
function clearPlayhead(){
  document.querySelectorAll('.cell').forEach(cell=> cell.classList.remove('playhead'));
}

// =======================
// Controls
// =======================
const tempoInput = document.getElementById('tempo');
const tempoVal = document.getElementById('tempoVal');
const swingInput = document.getElementById('swing');
const swingVal = document.getElementById('swingVal');
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');

function setTempo(v){ state.tempo = +v; tempoVal.textContent = Math.round(state.tempo); }
function setSwing(v){ state.swing = +v; swingVal.textContent = Math.round(state.swing); }

setTempo(tempoInput.value); setSwing(swingInput.value);

tempoInput.addEventListener('input', e=> setTempo(e.target.value));
swingInput.addEventListener('input', e=> setSwing(e.target.value));

playBtn.addEventListener('click', ()=>{ if(!isPlaying){ start(); }});
stopBtn.addEventListener('click', ()=>{ if(isPlaying){ stop(); }});

// Clear & Randomize
const clearBtn = document.getElementById('clearBtn');
const randomBtn = document.getElementById('randomBtn');
clearBtn.addEventListener('click', ()=>{
  state.tracks.forEach(t=> t.steps = Array(NUM_STEPS).fill(false));
  refreshGrid();
});
randomBtn.addEventListener('click', ()=>{
  state.tracks.forEach((t,idx)=>{
    for(let i=0;i<NUM_STEPS;i++){
      const prob = [0.7, 0.4, 0.6, 0.35][idx]; // kick denser
      t.steps[i] = Math.random() < (i%4===0? 0.85 : prob); // emphasise downbeats
    }
  });
  refreshGrid();
});

// =======================
// Save / Load Patterns (localStorage)
// =======================
const patternNameEl = document.getElementById('patternName');
const patternListEl = document.getElementById('patternList');
const saveBtn = document.getElementById('savePattern');
const loadBtn = document.getElementById('loadPattern');
const delBtn = document.getElementById('deletePattern');

function getPatterns(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ return []; } }
function setPatterns(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); populatePatternList(); }
function populatePatternList(){
  const arr = getPatterns();
  patternListEl.innerHTML = '';
  arr.forEach((p,idx)=>{
    const opt = document.createElement('option'); opt.value = idx; opt.textContent = p.name || ('Pattern '+(idx+1)); patternListEl.appendChild(opt);
  });
  if (arr.length===0){ const opt=document.createElement('option'); opt.textContent='(no saved patterns)'; opt.value=''; patternListEl.appendChild(opt);} 
}

saveBtn.addEventListener('click', ()=>{
  const name = patternNameEl.value.trim() || `Pattern ${new Date().toLocaleTimeString()}`;
  const payload = {
    name,
    tempo: state.tempo,
    swing: state.swing,
    tracks: state.tracks.map(t=> ({ name:t.name, steps:[...t.steps] }))
  };
  const arr = getPatterns(); arr.push(payload); setPatterns(arr); patternNameEl.value = name;
});

loadBtn.addEventListener('click', ()=>{
  const idx = +patternListEl.value; const arr = getPatterns(); if(!arr.length || isNaN(idx)) return;
  const p = arr[idx];
  state.tempo = p.tempo || 120; tempoInput.value = state.tempo; tempoVal.textContent = state.tempo;
  state.swing = p.swing || 0; swingInput.value = state.swing; swingVal.textContent = state.swing;
  p.tracks.forEach((pt, i)=>{ if(state.tracks[i]) state.tracks[i].steps = pt.steps.slice(0, NUM_STEPS); });
  refreshGrid();
});

delBtn.addEventListener('click', ()=>{
  const idx = +patternListEl.value; const arr = getPatterns(); if(isNaN(idx) || !arr.length) return;
  arr.splice(idx,1); setPatterns(arr);
});

populatePatternList();

// =======================
// Export WAV (render with OfflineAudioContext)
// =======================
const exportBtn = document.getElementById('exportBtn');
const loopsEl = document.getElementById('loops');

function encodeWAV(audioBuffer){
  const numCh = audioBuffer.numberOfChannels;
  const samples = audioBuffer.length;
  const rate = audioBuffer.sampleRate;
  const data = new Float32Array(samples * numCh);
  for (let ch=0; ch<numCh; ch++){
    data.set(audioBuffer.getChannelData(ch), ch);
  }
  // Interleave (mono or stereo supported)
  let interleaved;
  if (numCh === 2){
    const L = audioBuffer.getChannelData(0), R = audioBuffer.getChannelData(1);
    interleaved = new Float32Array(samples*2);
    for(let i=0,j=0;i<samples;i++,j+=2){ interleaved[j]=L[i]; interleaved[j+1]=R[i]; }
  } else {
    interleaved = data; // mono
  }
  // Convert to PCM16
  const pcm = new DataView(new ArrayBuffer(44 + interleaved.length*2));
  function writeString(off,str){ for(let i=0;i<str.length;i++) pcm.setUint8(off+i, str.charCodeAt(i)); }
  let offset=0;
  writeString(offset, 'RIFF'); offset+=4;
  pcm.setUint32(offset, 36 + interleaved.length*2, true); offset+=4;
  writeString(offset, 'WAVE'); offset+=4;
  writeString(offset, 'fmt '); offset+=4;
  pcm.setUint32(offset, 16, true); offset+=4; // PCM chunk size
  pcm.setUint16(offset, 1, true); offset+=2;   // PCM format
  pcm.setUint16(offset, numCh, true); offset+=2;
  pcm.setUint32(offset, rate, true); offset+=4;
  pcm.setUint32(offset, rate * numCh * 2, true); offset+=4; // byte rate
  pcm.setUint16(offset, numCh * 2, true); offset+=2; // block align
  pcm.setUint16(offset, 16, true); offset+=2; // bits per sample
  writeString(offset, 'data'); offset+=4;
  pcm.setUint32(offset, interleaved.length*2, true); offset+=4;
  // samples
  let idx=offset;
  for (let i=0;i<interleaved.length;i++, idx+=2){
    let s = Math.max(-1, Math.min(1, interleaved[i]));
    pcm.setInt16(idx, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
  }
  return new Blob([pcm.buffer], { type: 'audio/wav' });
}

function renderOfflineAndDownload(){
  const loops = Math.max(1, Math.min(16, parseInt(loopsEl.value)||2));
  const sr = 44100;
  const baseDur = stepDurationSec(state.tempo);
  const totalTime = baseDur * NUM_STEPS * loops + 1.0; // + tail
  const length = Math.ceil(totalTime * sr);
  const off = new OfflineAudioContext(2, length, sr);

  // schedule events
  function offTrigger(trackIndex, time){
    switch(trackIndex){
      case 0: offKick(time); break; case 1: offSnare(time); break; case 2: offHat(time); break; case 3: offClap(time); break;
    }
  }
  // Offline versions (use the offline context)
  function offKick(time){
    const o = off.createOscillator(); const g = off.createGain();
    o.type='sine'; o.frequency.setValueAtTime(150,time); o.frequency.exponentialRampToValueAtTime(50,time+0.12);
    g.gain.setValueAtTime(1,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.15);
    o.connect(g).connect(off.destination); o.start(time); o.stop(time+0.16);
  }
  function offSnare(time){
    const bufferSize = off.sampleRate * 0.2; const buffer = off.createBuffer(1, bufferSize, off.sampleRate);
    const data = buffer.getChannelData(0); for(let i=0;i<buffer.length;i++) data[i]=Math.random()*2-1;
    const noise = off.createBufferSource(); noise.buffer=buffer;
    const bp = off.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.8;
    const g = off.createGain(); g.gain.setValueAtTime(0.6,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.2);
    const o = off.createOscillator(); o.type='triangle'; const g2 = off.createGain(); g2.gain.setValueAtTime(0.4,time); g2.gain.exponentialRampToValueAtTime(0.001,time+0.12);
    o.frequency.setValueAtTime(220,time); o.frequency.exponentialRampToValueAtTime(160,time+0.1);
    noise.connect(bp).connect(g); o.connect(g2);
    const mix = off.createGain(); g.connect(mix); g2.connect(mix); mix.connect(off.destination);
    noise.start(time); noise.stop(time+0.2); o.start(time); o.stop(time+0.12);
  }
  function offHat(time){
    const len=0.07; const bufferSize = off.sampleRate * len; const buffer = off.createBuffer(1, bufferSize, off.sampleRate);
    const data = buffer.getChannelData(0); for(let i=0;i<buffer.length;i++) data[i]=(Math.random()*2-1)*(1-i/buffer.length);
    const src = off.createBufferSource(); src.buffer=buffer;
    const hp = off.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; hp.Q.value=0.7;
    const g = off.createGain(); g.gain.setValueAtTime(0.35,time); g.gain.exponentialRampToValueAtTime(0.001,time+len);
    src.connect(hp).connect(g).connect(off.destination); src.start(time); src.stop(time+len);
  }
  function offClap(time){
    const bursts=[0,0.012,0.025,0.045];
    bursts.forEach((offt,i)=>{
      const len=0.12; const bufLen=off.sampleRate*len; const buffer=off.createBuffer(1, bufLen, off.sampleRate);
      const data=buffer.getChannelData(0); for(let j=0;j<buffer.length;j++) data[j]=Math.random()*2-1;
      const src=off.createBufferSource(); src.buffer=buffer; const hp=off.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000; hp.Q.value=0.5;
      const g=off.createGain(); g.gain.setValueAtTime(0.5/(i+1), time+offt); g.gain.exponentialRampToValueAtTime(0.001, time+offt+len);
      src.connect(hp).connect(g).connect(off.destination); src.start(time+offt); src.stop(time+offt+len);
    });
  }

  const swingAmt = (state.swing/100) * (baseDur * 0.5);
  for(let loop=0; loop<loops; loop++){
    for(let step=0; step<NUM_STEPS; step++){
      const baseTime = (loop * NUM_STEPS + step) * baseDur;
      const time = baseTime + (step%2===1 ? swingAmt : 0);
      state.tracks.forEach((t,ti)=>{ if(t.steps[step]) offTrigger(ti, time); });
    }
  }

  off.startRendering().then(rendered=>{
    const blob = encodeWAV(rendered);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url;
    const name = (patternNameEl.value.trim() || 'pattern');
    a.download = `${name.replace(/\s+/g,'_')}_${state.tempo}bpm_${loops}x16.wav`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
}

exportBtn.addEventListener('click', ()=>{
  // Ensure we've got user gesture audio context once before offline (some browsers require it)
  ensureAudio();
  renderOfflineAndDownload();
});

// Init
buildGrid();

// Friendly demo default
state.tracks[0].steps = [true,false,false,false, true,false,false,false, true,false,false,false, true,false,false,false]; // 4-on-the-floor
state.tracks[1].steps = [false,false,false,false, true,false,false,false, false,false,false,false, true,false,true,false];
state.tracks[2].steps = Array(NUM_STEPS).fill(true); // 16th hats
state.tracks[3].steps = [false,false,false,false, false,false,true,false, false,false,false,false, false,false,true,false];
refreshGrid();

// Shine the grid on first paint
requestAnimationFrame(()=>{
  document.querySelectorAll('.cell').forEach((c,i)=>{
    c.animate([{ filter:'brightness(1.8)' }, { filter:'brightness(1)' }], {duration:300, delay: i*6});
  });
});
</script>
</body>
</html>
